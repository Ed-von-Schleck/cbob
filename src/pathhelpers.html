<!DOCTYPE html><html lang="en"><head><title>src/pathhelpers</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/pathhelpers"><meta name="groc-project-path" content="src/pathhelpers.py"><meta name="groc-github-url" content="https://github.com/Ed-von-Schleck/cbob"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/Ed-von-Schleck/cbob/blob/master/src/pathhelpers.py">src/pathhelpers.py</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="k">def</span> <span class="nf">get_project_root</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">get_project_root</span><span class="p">,</span> <span class="s">&quot;_project_root&quot;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">oldpath</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">path</span> <span class="o">!=</span> <span class="n">oldpath</span><span class="p">:</span>
            <span class="n">oldpath</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;.cbob&quot;</span><span class="p">)):</span>
                <span class="n">get_project_root</span><span class="o">.</span><span class="n">_project_root</span> <span class="o">=</span> <span class="n">path</span>
                <span class="k">break</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get_project_root</span><span class="o">.</span><span class="n">_project_root</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">get_project_root</span><span class="o">.</span><span class="n">_project_root</span>

<span class="k">def</span> <span class="nf">get_cbob_dir</span><span class="p">():</span>
    <span class="n">project_root</span> <span class="o">=</span> <span class="n">get_project_root</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">project_root</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_root</span><span class="p">,</span> <span class="s">&quot;.cbob&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_targets_dir</span><span class="p">():</span>
    <span class="n">project_root</span> <span class="o">=</span> <span class="n">get_project_root</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">project_root</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_root</span><span class="p">,</span> <span class="s">&quot;.cbob&quot;</span><span class="p">,</span> <span class="s">&quot;targets&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_target_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">targets_dir</span> <span class="o">=</span> <span class="n">get_targets_dir</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">targets_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">targets_dir</span><span class="p">,</span> <span class="n">target_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_sources_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">target_dir</span> <span class="o">=</span> <span class="n">get_target_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="s">&quot;sources&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_objects_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">target_dir</span> <span class="o">=</span> <span class="n">get_target_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="s">&quot;objects&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_compiler_symlink</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">target_dir</span> <span class="o">=</span> <span class="n">get_target_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="s">&quot;compiler&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_linker_symlink</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">target_dir</span> <span class="o">=</span> <span class="n">get_target_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="s">&quot;linker&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_bindir_symlink</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">target_dir</span> <span class="o">=</span> <span class="n">get_target_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="s">&quot;bindir&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_gcc_path</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">&quot;which&quot;</span><span class="p">,</span> <span class="s">&quot;gcc&quot;</span><span class="p">],</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">mangle_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">project_root</span> <span class="o">=</span> <span class="n">get_project_root</span><span class="p">()</span>
    <span class="n">abs_actual_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">norm_actual_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">abs_actual_file_path</span><span class="p">,</span> <span class="n">project_root</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">norm_actual_file_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">demangle_path_rel</span><span class="p">(</span><span class="n">mangled_path</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mangled_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">demangle_path_abs</span><span class="p">(</span><span class="n">mangled_path</span><span class="p">):</span>
    <span class="n">path_rel</span> <span class="o">=</span> <span class="n">demangle_path_rel</span><span class="p">(</span><span class="n">mangled_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_root</span><span class="p">,</span> <span class="n">path_rel</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_object_file_path</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">mangled_file_name</span> <span class="o">=</span> <span class="n">mangle_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">objects_dir</span> <span class="o">=</span> <span class="n">get_objects_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">objects_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">objects_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">mangled_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.o&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_deps_file_path</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">target_dir</span> <span class="o">=</span> <span class="n">get_target_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="s">&quot;deps&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_source_path_from_symlink</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">symlink_path</span><span class="p">):</span>
    <span class="n">sources_dir</span> <span class="o">=</span> <span class="n">get_sources_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_dir</span><span class="p">,</span> <span class="n">symlink_path</span><span class="p">))))</span>

<span class="k">def</span> <span class="nf">get_bin_path</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">bindir</span> <span class="o">=</span> <span class="n">get_bindir_symlink</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">bindir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">bindir</span><span class="p">),</span> <span class="n">target_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_precompiled_headers_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">target_dir</span> <span class="o">=</span> <span class="n">get_target_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="s">&quot;precompiled_headers&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_uncompiled_header_path</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">mangled_file_name</span> <span class="o">=</span> <span class="n">mangle_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">precompiled_headers_dir</span> <span class="o">=</span> <span class="n">get_precompiled_headers_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">precompiled_headers_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">precompiled_headers_dir</span><span class="p">,</span> <span class="n">mangled_file_name</span> <span class="o">+</span> <span class="s">&quot;.h&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_precompiled_header_path</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">mangled_file_name</span> <span class="o">=</span> <span class="n">mangle_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>avoid double .h appearing before .gch</p></div></div><div class="code"><div class="wrapper">    <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">mangled_file_name</span><span class="p">)</span>
    <span class="n">mangled_file_name</span> <span class="o">=</span> <span class="n">root</span> <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;.h&quot;</span> <span class="k">else</span> <span class="n">mangled_file_name</span>
    <span class="n">precompiled_headers_dir</span> <span class="o">=</span> <span class="n">get_precompiled_headers_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">precompiled_headers_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">precompiled_headers_dir</span><span class="p">,</span> <span class="n">mangled_file_name</span> <span class="o">+</span> <span class="s">&quot;.h.gch&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_dependencies_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
    <span class="n">target_dir</span> <span class="o">=</span> <span class="n">get_target_dir</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="s">&quot;dependencies&quot;</span><span class="p">)</span></div></div></div></div></body></html>